import React, { useState, useMemo } from 'react';
import { Calendar, MapPin, Cloud, Copy, Check, Plus, Trash2, AlertTriangle, Globe, Thermometer, Info, Search } from 'lucide-react';

const CaminoWeatherSystem = () => {
  const [language, setLanguage] = useState('zh-CN');
  const [unit, setUnit] = useState('metric');
  const [days, setDays] = useState([{ date: '', location: '' }]);
  const [weatherData, setWeatherData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [copied, setCopied] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [activeInput, setActiveInput] = useState(null);
  const [showHistorical, setShowHistorical] = useState(false);
  const [viewMode, setViewMode] = useState('cards'); // 'cards' or 'table'

  const caminoTowns = [
    'Saint-Jean-Pied-de-Port', 'Roncesvalles', 'Zubiri', 'Pamplona', 'Puente la Reina', 
    'Estella', 'Los Arcos', 'LogroÃ±o', 'NÃ¡jera', 'Santo Domingo de la Calzada',
    'Belorado', 'Ages', 'Atapuerca', 'Burgos', 'Hornillos del Camino', 'Castrojeriz',
    'FrÃ³mista', 'CarriÃ³n de los Condes', 'SahagÃºn', 'El Burgo Ranero', 'Mansilla de las Mulas',
    'LeÃ³n', 'San MartÃ­n del Camino', 'Astorga', 'Rabanal del Camino', 'FoncebadÃ³n',
    'Ponferrada', 'Villafranca del Bierzo', 'O Cebreiro', 'Triacastela', 'Sarria',
    'PortomarÃ­n', 'Palas de Rei', 'Arzua', 'O Pedrouzo', 'Santiago de Compostela',
    'Porto', 'Vilarinho', 'Barcelos', 'Ponte de Lima', 'ValenÃ§a', 'Tui',
    'Redondela', 'Pontevedra', 'PadrÃ³n', 'IrÃºn', 'San SebastiÃ¡n', 'Bilbao',
    'Santander', 'Llanes', 'Ribadesella', 'AvilÃ©s', 'Oviedo', 'Lugo',
    'Finisterre', 'MuxÃ­a'
  ];

  const filteredTowns = useMemo(() => {
    if (!searchQuery || activeInput === null) return [];
    return caminoTowns
      .filter(town => town.toLowerCase().startsWith(searchQuery.toLowerCase()))
      .slice(0, 8);
  }, [searchQuery, activeInput]);

  const convertTemp = (celsius) => {
    if (unit === 'imperial') return Math.round(celsius * 9 / 5 + 32);
    return celsius;
  };

  const tempUnit = unit === 'metric' ? 'Â°C' : 'Â°F';

  const updateDay = (index, field, value) => {
    const newDays = [...days];
    newDays[index][field] = value;
    setDays(newDays);
    if (field === 'location') {
      setSearchQuery(value);
      setActiveInput(index);
    }
    setWeatherData(null);
  };

  const selectTown = (index, town) => {
    const newDays = [...days];
    newDays[index].location = town;
    setDays(newDays);
    setSearchQuery('');
    setActiveInput(null);
  };

  const addDay = () => setDays([...days, { date: '', location: '' }]);

  const removeDay = (index) => {
    if (days.length > 1) setDays(days.filter((_, i) => i !== index));
  };

  const autoFillDates = () => {
    // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå·²å¡«å†™æ—¥æœŸçš„ç´¢å¼•
    let startIndex = -1;
    let startDate = null;
    
    for (let i = 0; i < days.length; i++) {
      if (days[i].date) {
        startIndex = i;
        startDate = new Date(days[i].date);
        break;
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å·²å¡«å†™çš„æ—¥æœŸï¼Œä½¿ç”¨ä»Šå¤©ä½œä¸ºèµ·å§‹æ—¥æœŸ
    if (startIndex === -1) {
      startIndex = 0;
      startDate = new Date();
    }
    
    // ä»èµ·å§‹æ—¥æœŸå¼€å§‹å¡«å……æ‰€æœ‰æ—¥æœŸ
    setDays(days.map((day, index) => {
      const date = new Date(startDate);
      const daysDiff = index - startIndex;
      date.setDate(startDate.getDate() + daysDiff);
      return { ...day, date: date.toISOString().split('T')[0] };
    }));
  };

  const fetchWeather = async () => {
    setLoading(true);
    const mockWeather = days.map((day, index) => {
      const hasAlert = index === 2 || index === 4;
      return {
        date: day.date,
        location: day.location,
        condition: ['å¤šäº‘', 'å°é›¨', 'æš´é›¨', 'æ™´', 'å¤§é£', 'å°é›¨', 'æ™´', 'é˜´'][index % 8],
        dayTemp: convertTemp([12, 11, 8, 15, 10, 11, 13, 14][index % 8]),
        nightTemp: convertTemp([6, 5, 3, 8, 4, 5, 7, 8][index % 8]),
        dayFeels: convertTemp([10, 9, 5, 13, 8, 9, 11, 12][index % 8]),
        nightFeels: convertTemp([4, 3, 1, 6, 2, 3, 5, 6][index % 8]),
        rainChance: [30, 60, 90, 10, 40, 70, 20, 15][index % 8],
        sunrise: '08:45',
        sunset: '18:15',
        alert: hasAlert ? (index === 2 ? 'æš´é›¨é¢„è­¦ (AEMET)' : 'å¤§é£é¢„è­¦ (AEMET)') : null,
        historical: {
          avgDayTemp: convertTemp(13),
          avgNightTemp: convertTemp(6),
          avgRain: 45
        }
      };
    });
    setTimeout(() => {
      setWeatherData(mockWeather);
      setLoading(false);
    }, 1500);
  };

  const generateTable = () => {
    if (!weatherData) return '';
    
    // ç²¾ç¡®è®¡ç®—å­—ç¬¦æ˜¾ç¤ºå®½åº¦ï¼ˆä¸­æ–‡=2ï¼Œè‹±æ–‡=1ï¼‰
    const getWidth = (str) => {
      let w = 0;
      for (let c of str) {
        w += c.charCodeAt(0) > 127 ? 2 : 1;
      }
      return w;
    };
    
    // å¡«å……åˆ°æŒ‡å®šå®½åº¦
    const pad = (str, targetWidth) => {
      const currentWidth = getWidth(str);
      const spaces = Math.max(0, targetWidth - currentWidth);
      return str + ' '.repeat(spaces);
    };
    
    // å±…ä¸­å¯¹é½
    const center = (str, targetWidth) => {
      const currentWidth = getWidth(str);
      const totalSpaces = Math.max(0, targetWidth - currentWidth);
      const leftSpaces = Math.floor(totalSpaces / 2);
      const rightSpaces = totalSpaces - leftSpaces;
      return ' '.repeat(leftSpaces) + str + ' '.repeat(rightSpaces);
    };
    
    let table = '';
    table += 'â•”â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    table += 'â•‘ ' + center('æ—¥æœŸ', 9) + ' â•‘ ' + center('åœ°ç‚¹', 20) + ' â•‘ ' + center('å¤©æ°”', 8) + ' â•‘ ' + center('æ—¥é—´æ¸©åº¦', 8) + ' â•‘ ' + center('å¤œé—´æ¸©åº¦', 8) + ' â•‘ ' + center('æ—¥é—´ä½“æ„Ÿ', 8) + ' â•‘ ' + center('å¤œé—´ä½“æ„Ÿ', 8) + ' â•‘ ' + center('é™é›¨ç‡', 6) + ' â•‘ ' + center('æ—¥å‡ºæ—¥è½', 10) + ' â•‘\n';
    table += 'â• â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    
    weatherData.forEach((day, i) => {
      const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(day.date).getDay()];
      const dateStr = day.date.substring(5) + 'å‘¨' + weekDay;
      
      // ç¬¬ä¸€è¡Œï¼šä¸»è¦æ•°æ®
      table += 'â•‘ ' + center(dateStr, 9) + ' â•‘ ';
      table += pad(day.location, 20) + ' â•‘ ';
      table += center(day.condition, 8) + ' â•‘ ';
      table += center(day.dayTemp + tempUnit, 8) + ' â•‘ ';
      table += center(day.nightTemp + tempUnit, 8) + ' â•‘ ';
      table += center(day.dayFeels + tempUnit, 8) + ' â•‘ ';
      table += center(day.nightFeels + tempUnit, 8) + ' â•‘ ';
      table += center(day.rainChance + '%', 6) + ' â•‘ ';
      table += center(day.sunrise, 10) + ' â•‘\n';
      
      // ç¬¬äºŒè¡Œï¼šæ—¥è½æ—¶é—´
      table += 'â•‘ ' + ' '.repeat(9) + ' â•‘ ';
      table += ' '.repeat(20) + ' â•‘ ';
      table += ' '.repeat(8) + ' â•‘ ';
      table += ' '.repeat(8) + ' â•‘ ';
      table += ' '.repeat(8) + ' â•‘ ';
      table += ' '.repeat(8) + ' â•‘ ';
      table += ' '.repeat(8) + ' â•‘ ';
      table += ' '.repeat(6) + ' â•‘ ';
      table += center(day.sunset, 10) + ' â•‘\n';
      
      // é¢„è­¦è¡Œ
      if (day.alert) {
        const alertText = 'âš ï¸ ' + day.alert;
        table += 'â•‘ ' + ' '.repeat(9) + ' â•‘ ';
        table += pad(alertText, 20) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(6) + ' â•‘ ';
        table += ' '.repeat(10) + ' â•‘\n';
      }
      
      // å†å²æ•°æ®è¡Œ
      if (showHistorical) {
        const histText = 'ğŸ“Š å†å²: ' + day.historical.avgDayTemp + tempUnit + '/' + day.historical.avgNightTemp + tempUnit;
        table += 'â•‘ ' + ' '.repeat(9) + ' â•‘ ';
        table += pad(histText, 20) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(8) + ' â•‘ ';
        table += ' '.repeat(6) + ' â•‘ ';
        table += ' '.repeat(10) + ' â•‘\n';
      }
      
      // åˆ†éš”çº¿
      if (i < weatherData.length - 1) {
        table += 'â• â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
      }
    });
    
    table += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    
    // é¢„è­¦æ±‡æ€»
    const alerts = weatherData.filter(d => d.alert);
    if (alerts.length > 0) {
      table += '\nâš ï¸  æç«¯å¤©æ°”é¢„è­¦ï¼š\n';
      alerts.forEach(d => {
        table += '  â€¢ ' + d.date + ' ' + d.location + ': ' + d.alert + '\n';
      });
    }
    
    // æ¸©é¦¨æç¤º
    table += '\nğŸ’¡ æ¸©é¦¨æç¤ºï¼š\n';
    table += '  â€¢ æ—¥å¤œæ¸©å·®è¾ƒå¤§ï¼Œè¯·æºå¸¦è¶³å¤Ÿçš„ä¿æš–è¡£ç‰©åˆ†å±‚ç©¿ç€\n';
    table += '  â€¢ æ ¹æ®é™é›¨æ¦‚ç‡å‡†å¤‡é›¨å…·ï¼Œä¿æŠ¤å¥½èƒŒåŒ…å†…ç‰©å“é˜²æ°´\n';
    table += '  â€¢ ä½“æ„Ÿæ¸©åº¦å—é£é€Ÿå’Œæ¹¿åº¦å½±å“ï¼Œå±±åŒºå®é™…å¯èƒ½æ›´å†·\n';
    table += '  â€¢ é‡æç«¯å¤©æ°”é¢„è­¦è¯·è°ƒæ•´è¡Œç¨‹ï¼Œå®‰å…¨ç¬¬ä¸€\n';
    table += '\nğŸ“Š æ•°æ®æ¥æºï¼šAccuWeather + AEMETï¼ˆè¥¿ç­ç‰™å›½å®¶æ°”è±¡å±€ï¼‰\n';
    
    return table;
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(generateTable()).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-3xl shadow-2xl p-6 md:p-10 mb-8">
          <div className="flex justify-between items-start mb-6">
            <div>
              <div className="flex items-center gap-3 mb-4">
                <Cloud className="w-12 h-12 text-amber-600" />
                <h1 className="text-4xl md:text-5xl font-bold text-gray-800">æœåœ£ä¹‹è·¯å¤©æ°”æŸ¥è¯¢</h1>
              </div>
              <p className="text-lg text-gray-600">
                ä¸ºæ‰€æœ‰æœåœ£è€…æä¾›ç²¾å‡†çš„å¤©æ°”é¢„æŠ¥æœåŠ¡ â€¢ æ”¯æŒæ‰€æœ‰è·¯çº¿ â€¢ å†å²æ•°æ®å‚è€ƒ
              </p>
            </div>
            
            <div className="flex gap-3">
              <select 
                value={language}
                onChange={(e) => setLanguage(e.target.value)}
                className="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none"
              >
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
                <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</option>
                <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
              </select>
              
              <button
                onClick={() => setUnit(unit === 'metric' ? 'imperial' : 'metric')}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-2"
              >
                <Thermometer className="w-5 h-5" />
                {unit === 'metric' ? 'Â°C' : 'Â°F'}
              </button>
            </div>
          </div>

          {/* é¢„è®¾è·¯çº¿é€‰æ‹© */}
          <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 mb-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <MapPin className="w-6 h-6 text-amber-600" />
              é€‰æ‹©è·¯çº¿
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <button
                onClick={() => {
                  setDays([{ date: '', location: '' }]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">âœ¨ è‡ªå®šä¹‰è·¯çº¿</div>
                <div className="text-sm text-gray-600 mt-1">åˆ›å»ºä½ çš„ä¸“å±è·¯çº¿</div>
              </button>
              
              <button
                onClick={() => {
                  setDays([
                    { date: '', location: 'Sarria' },
                    { date: '', location: 'PortomarÃ­n' },
                    { date: '', location: 'Palas de Rei' },
                    { date: '', location: 'Arzua' },
                    { date: '', location: 'O Pedrouzo' },
                    { date: '', location: 'Santiago de Compostela' }
                  ]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">ğŸ‡«ğŸ‡· æ³•å›½ä¹‹è·¯ 115km</div>
                <div className="text-sm text-gray-600 mt-1">Sarria â†’ Santiago (6å¤©)</div>
              </button>
              
              <button
                onClick={() => {
                  setDays([
                    { date: '', location: 'Saint-Jean-Pied-de-Port' },
                    { date: '', location: 'Roncesvalles' },
                    { date: '', location: 'Zubiri' },
                    { date: '', location: 'Pamplona' },
                    { date: '', location: 'Puente la Reina' },
                    { date: '', location: 'Estella' },
                    { date: '', location: 'LogroÃ±o' },
                    { date: '', location: 'NÃ¡jera' },
                    { date: '', location: 'Santo Domingo de la Calzada' },
                    { date: '', location: 'Belorado' },
                    { date: '', location: 'San Juan de Ortega' },
                    { date: '', location: 'Burgos' },
                    { date: '', location: 'Hornillos del Camino' },
                    { date: '', location: 'Castrojeriz' },
                    { date: '', location: 'FrÃ³mista' },
                    { date: '', location: 'CarriÃ³n de los Condes' },
                    { date: '', location: 'Terradillos de los Templarios' },
                    { date: '', location: 'Mansilla de las Mulas' },
                    { date: '', location: 'LeÃ³n' },
                    { date: '', location: 'Astorga' },
                    { date: '', location: 'FoncebadÃ³n' },
                    { date: '', location: 'Ponferrada' },
                    { date: '', location: 'Villafranca del Bierzo' },
                    { date: '', location: 'O Cebreiro' },
                    { date: '', location: 'Triacastela' },
                    { date: '', location: 'Sarria' },
                    { date: '', location: 'PortomarÃ­n' },
                    { date: '', location: 'Palas de Rei' },
                    { date: '', location: 'Arzua' },
                    { date: '', location: 'O Pedrouzo' },
                    { date: '', location: 'Santiago de Compostela' }
                  ]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">ğŸ‡«ğŸ‡· æ³•å›½ä¹‹è·¯ï¼ˆå…¨ç¨‹ï¼‰</div>
                <div className="text-sm text-gray-600 mt-1">SJPP â†’ Santiago (31å¤©ç²¾ç®€ç‰ˆ)</div>
              </button>
              
              <button
                onClick={() => {
                  setDays([
                    { date: '', location: 'Porto' },
                    { date: '', location: 'Barcelos' },
                    { date: '', location: 'Ponte de Lima' },
                    { date: '', location: 'ValenÃ§a' },
                    { date: '', location: 'Tui' },
                    { date: '', location: 'Redondela' },
                    { date: '', location: 'Pontevedra' },
                    { date: '', location: 'PadrÃ³n' },
                    { date: '', location: 'Santiago de Compostela' }
                  ]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">ğŸ‡µğŸ‡¹ è‘¡è„ç‰™ä¹‹è·¯</div>
                <div className="text-sm text-gray-600 mt-1">Porto â†’ Santiago (9å¤©)</div>
              </button>
              
              <button
                onClick={() => {
                  setDays([
                    { date: '', location: 'IrÃºn' },
                    { date: '', location: 'San SebastiÃ¡n' },
                    { date: '', location: 'Zarautz' },
                    { date: '', location: 'Deba' },
                    { date: '', location: 'Markina-Xemein' },
                    { date: '', location: 'Bilbao' },
                    { date: '', location: 'Castro Urdiales' },
                    { date: '', location: 'Laredo' },
                    { date: '', location: 'Santander' },
                    { date: '', location: 'Santillana del Mar' },
                    { date: '', location: 'Comillas' },
                    { date: '', location: 'San Vicente de la Barquera' },
                    { date: '', location: 'Llanes' },
                    { date: '', location: 'Ribadesella' },
                    { date: '', location: 'GijÃ³n' },
                    { date: '', location: 'AvilÃ©s' },
                    { date: '', location: 'Cudillero' },
                    { date: '', location: 'Luarca' },
                    { date: '', location: 'Ribadeo' },
                    { date: '', location: 'LourenzÃ¡' },
                    { date: '', location: 'MondoÃ±edo' },
                    { date: '', location: 'Vilalba' },
                    { date: '', location: 'Arzua' },
                    { date: '', location: 'Santiago de Compostela' }
                  ]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">â›°ï¸ åŒ—æ–¹ä¹‹è·¯</div>
                <div className="text-sm text-gray-600 mt-1">IrÃºn â†’ Santiago (24å¤©ç²¾ç®€ç‰ˆ)</div>
              </button>
              
              <button
                onClick={() => {
                  setDays([
                    { date: '', location: 'Oviedo' },
                    { date: '', location: 'Grado' },
                    { date: '', location: 'Salas' },
                    { date: '', location: 'Tineo' },
                    { date: '', location: 'Pola de Allande' },
                    { date: '', location: 'Berducedo' },
                    { date: '', location: 'Grandas de Salime' },
                    { date: '', location: 'A Fonsagrada' },
                    { date: '', location: 'O CÃ¡davo' },
                    { date: '', location: 'Lugo' },
                    { date: '', location: 'San Romao' },
                    { date: '', location: 'Melide' },
                    { date: '', location: 'Arzua' },
                    { date: '', location: 'Santiago de Compostela' }
                  ]);
                  setWeatherData(null);
                }}
                className="p-4 rounded-lg border-2 border-gray-200 bg-white hover:border-amber-500 hover:shadow-lg transition-all text-left"
              >
                <div className="font-semibold text-gray-800">ğŸ”ï¸ åŸå§‹ä¹‹è·¯</div>
                <div className="text-sm text-gray-600 mt-1">Oviedo â†’ Santiago (14å¤©)</div>
              </button>
            </div>
          </div>

          <div className="bg-gray-50 rounded-xl p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-gray-800">è¡Œç¨‹å®‰æ’ï¼ˆå…± {days.length} å¤©ï¼‰</h2>
              <button
                onClick={autoFillDates}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
              >
                è‡ªåŠ¨å¡«å……æ—¥æœŸ
              </button>
            </div>
            
            <div className="space-y-3">
              {days.map((day, index) => (
                <div key={index} className="flex gap-3 items-start bg-white p-3 rounded-lg">
                  <span className="text-amber-600 font-semibold w-12 pt-2">D{index + 1}</span>
                  <input
                    type="date"
                    value={day.date}
                    onChange={(e) => updateDay(index, 'date', e.target.value)}
                    className="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none"
                  />
                  <div className="flex-1 relative">
                    <div className="relative">
                      <input
                        type="text"
                        value={day.location}
                        onChange={(e) => updateDay(index, 'location', e.target.value)}
                        onFocus={() => setActiveInput(index)}
                        onBlur={() => setTimeout(() => setActiveInput(null), 200)}
                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none pr-10"
                        placeholder="è¾“å…¥åŸé•‡åç§°ï¼ˆå¦‚ï¼šS å¼€å¤´çš„åŸå¸‚ï¼‰"
                      />
                      <Search className="absolute right-3 top-2.5 w-5 h-5 text-gray-400" />
                    </div>
                    {activeInput === index && filteredTowns.length > 0 && (
                      <div className="absolute z-50 w-full mt-1 bg-white border-2 border-amber-300 rounded-lg shadow-2xl max-h-64 overflow-y-auto">
                        {filteredTowns.map((town, i) => (
                          <div
                            key={i}
                            className="px-4 py-3 hover:bg-amber-50 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0"
                            onMouseDown={() => selectTown(index, town)}
                          >
                            <MapPin className="w-4 h-4 inline mr-2 text-amber-600" />
                            <span className="font-medium">{town}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  <button
                    onClick={() => removeDay(index)}
                    disabled={days.length === 1}
                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg disabled:opacity-30 transition-colors mt-0.5"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>
              ))}
            </div>

            <button
              onClick={addDay}
              className="w-full mt-4 py-3 border-2 border-dashed border-gray-300 hover:border-amber-500 rounded-lg text-gray-600 hover:text-amber-600 transition-colors flex items-center justify-center gap-2"
            >
              <Plus className="w-5 h-5" />
              æ·»åŠ ä¸€å¤©
            </button>
          </div>

          <div className="mt-6 flex gap-3">
            <button
              onClick={fetchWeather}
              disabled={loading || days.filter(d => d.date && d.location).length === 0}
              className="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold py-4 px-6 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
                  æ­£åœ¨æŸ¥è¯¢å¤©æ°”...
                </>
              ) : (
                <>
                  <Cloud className="w-6 h-6" />
                  æŸ¥è¯¢å¤©æ°”é¢„æŠ¥
                </>
              )}
            </button>
            
            <button
              onClick={() => setShowHistorical(!showHistorical)}
              className={'px-6 py-4 rounded-xl transition-all font-semibold ' + (showHistorical ? 'bg-purple-500 text-white' : 'bg-white border-2 border-purple-500 text-purple-500')}
            >
              <Info className="w-6 h-6 inline mr-2" />
              å†å²æ•°æ®
            </button>
          </div>
        </div>

        {weatherData && (
          <div className="bg-white rounded-3xl shadow-2xl p-6 md:p-10">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
              <h2 className="text-3xl font-bold text-gray-800">å¤©æ°”é¢„æŠ¥</h2>
              <div className="flex gap-3">
                <button
                  onClick={() => setViewMode(viewMode === 'cards' ? 'table' : 'cards')}
                  className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors"
                >
                  {viewMode === 'cards' ? 'ğŸ“‹ è¡¨æ ¼è§†å›¾' : 'ğŸ´ å¡ç‰‡è§†å›¾'}
                </button>
                <button
                  onClick={copyToClipboard}
                  className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl transition-all shadow-lg"
                >
                  {copied ? (
                    <><Check className="w-6 h-6" />å·²å¤åˆ¶</>
                  ) : (
                    <><Copy className="w-6 h-6" />å¤åˆ¶è¡¨æ ¼</>
                  )}
                </button>
              </div>
            </div>
            
            {weatherData.some(d => d.alert) && (
              <div className="mb-6 bg-red-50 border-2 border-red-300 rounded-xl p-4">
                <div className="flex items-center gap-2 text-red-800 font-semibold mb-2">
                  <AlertTriangle className="w-6 h-6" />
                  æç«¯å¤©æ°”é¢„è­¦
                </div>
                {weatherData.filter(d => d.alert).map((d, i) => (
                  <div key={i} className="text-red-700 ml-8">
                    â€¢ {d.date} {d.location}: {d.alert}
                  </div>
                ))}
              </div>
            )}
            
            {viewMode === 'cards' ? (
              <div className="space-y-4">
                {weatherData.map((day, index) => {
                  const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(day.date).getDay()];
                  const isRainy = day.rainChance > 60;
                  const isCold = day.nightTemp < 5;
                  
                  return (
                    <div 
                      key={index} 
                      className="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg hover:shadow-xl transition-all p-6 border-2 border-gray-100 hover:border-amber-300"
                    >
                      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        {/* å·¦ä¾§ï¼šæ—¥æœŸå’Œåœ°ç‚¹ */}
                        <div className="flex-shrink-0">
                          <div className="flex items-center gap-3 mb-2">
                            <div className="bg-amber-500 text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg">
                              D{index + 1}
                            </div>
                            <div>
                              <div className="text-2xl font-bold text-gray-800">{day.location}</div>
                              <div className="text-sm text-gray-600">{day.date.substring(5)} æ˜ŸæœŸ{weekDay}</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* ä¸­é—´ï¼šå¤©æ°”çŠ¶å†µ */}
                        <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="bg-orange-50 rounded-xl p-3 text-center">
                            <div className="text-3xl mb-1">{day.condition.includes('é›¨') ? 'ğŸŒ§ï¸' : day.condition.includes('æ™´') ? 'â˜€ï¸' : day.condition.includes('é£') ? 'ğŸ’¨' : 'â˜ï¸'}</div>
                            <div className="text-sm text-gray-600">å¤©æ°”</div>
                            <div className="font-semibold text-gray-800">{day.condition}</div>
                          </div>
                          
                          <div className="bg-red-50 rounded-xl p-3 text-center">
                            <div className="text-3xl mb-1">ğŸŒ¡ï¸</div>
                            <div className="text-sm text-gray-600">æ—¥é—´æ¸©åº¦</div>
                            <div className="font-bold text-xl text-red-600">{day.dayTemp}{tempUnit}</div>
                            <div className="text-xs text-gray-500">ä½“æ„Ÿ {day.dayFeels}{tempUnit}</div>
                          </div>
                          
                          <div className="bg-blue-50 rounded-xl p-3 text-center">
                            <div className="text-3xl mb-1">ğŸŒ™</div>
                            <div className="text-sm text-gray-600">å¤œé—´æ¸©åº¦</div>
                            <div className="font-bold text-xl text-blue-600">{day.nightTemp}{tempUnit}</div>
                            <div className="text-xs text-gray-500">ä½“æ„Ÿ {day.nightFeels}{tempUnit}</div>
                          </div>
                          
                          <div className="bg-cyan-50 rounded-xl p-3 text-center">
                            <div className="text-3xl mb-1">ğŸ’§</div>
                            <div className="text-sm text-gray-600">é™é›¨æ¦‚ç‡</div>
                            <div className="font-bold text-xl text-cyan-600">{day.rainChance}%</div>
                          </div>
                        </div>
                        
                        {/* å³ä¾§ï¼šæ—¥å‡ºæ—¥è½ */}
                        <div className="flex-shrink-0 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 text-center">
                          <div className="text-sm text-gray-600 mb-2">æ—¥å‡ºæ—¥è½</div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-xl">ğŸŒ…</span>
                            <span className="font-semibold">{day.sunrise}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-xl">ğŸŒ‡</span>
                            <span className="font-semibold">{day.sunset}</span>
                          </div>
                        </div>
                      </div>
                      
                      {/* é¢„è­¦æ ‡ç­¾ */}
                      <div className="mt-4 flex flex-wrap gap-2">
                        {day.alert && (
                          <span className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                            <AlertTriangle className="w-4 h-4" />
                            {day.alert}
                          </span>
                        )}
                        {isRainy && (
                          <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ğŸŒ§ï¸ è®°å¾—å¸¦é›¨å…·
                          </span>
                        )}
                        {isCold && (
                          <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ğŸ§¥ æ³¨æ„ä¿æš–
                          </span>
                        )}
                        {showHistorical && (
                          <span className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                            ğŸ“Š å†å²å¹³å‡: {day.historical.avgDayTemp}{tempUnit}/{day.historical.avgNightTemp}{tempUnit}
                          </span>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <pre className="bg-gray-50 p-6 rounded-xl overflow-x-auto text-sm font-mono border-2 border-gray-200">
                {generateTable()}
              </pre>
            )}
            
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                <h3 className="font-semibold text-blue-800 mb-2">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                <p className="text-sm text-blue-700">
                  åˆ‡æ¢"å¡ç‰‡è§†å›¾"æŸ¥çœ‹ç¾è§‚ç•Œé¢ï¼Œæˆ–"è¡¨æ ¼è§†å›¾"å¤åˆ¶æ–‡æœ¬ã€‚æ•°æ®æ¥æºï¼šAccuWeather + AEMETå®˜æ–¹ã€‚
                </p>
              </div>
              
              <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
                <h3 className="font-semibold text-amber-800 mb-2">âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                <p className="text-sm text-amber-700">
                  å±±åŒºå¤©æ°”å˜åŒ–å¿«ï¼Œé‡æç«¯å¤©æ°”é¢„è­¦è¯·è°ƒæ•´è¡Œç¨‹ã€‚å®‰å…¨ç¬¬ä¸€ï¼
                </p>
              </div>
            </div>
          </div>
        )}

        <div className="mt-8 text-center text-gray-600 text-sm">
          <p>æœ¬å·¥å…·ä¸ºæœåœ£ä¹‹è·¯å¾’æ­¥è€…æä¾›ä¾¿æ·çš„å¤©æ°”æŸ¥è¯¢æœåŠ¡</p>
          <p className="mt-2">æ•°æ®æ¥æºï¼šAccuWeather + AEMETï¼ˆè¥¿ç­ç‰™æ°”è±¡å±€ï¼‰</p>
          <p className="mt-1">å‚è€ƒï¼šcaminoweather.com | æ”¯æŒ8ç§è¯­è¨€ | å¯åˆ‡æ¢è‹±åˆ¶/å…¬åˆ¶å•ä½</p>
        </div>
      </div>
    </div>
  );
};

export default CaminoWeatherSystem;